<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: transparent;
            font-family: Arial, sans-serif;
            overflow: hidden;
            width: 1920px;
            height: 1080px;
        }
        
        /* Always visible container */
        .lower-third {
            position: absolute;
            bottom: 50px;
            left: 50px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        /* Content that can be hidden */
        .content {
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        
        .content.visible {
            opacity: 1;
        }
        
        .show-title {
            font-size: 28px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        
        .artist-name {
            font-size: 36px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        
        .song-title {
            font-size: 24px;
            font-style: italic;
            margin-bottom: 6px;
        }
        
        .writer-name {
            font-size: 18px;
            font-style: italic;
        }
        
        .logo {
            position: absolute;
            bottom: 50px;
            right: 50px;
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        /* Debug info */
        .debug {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: #0f0;
            padding: 10px;
            font-family: monospace;
            font-size: 14px;
            border: 1px solid #0f0;
            display: none; /* Change to 'block' to see debug */
        }
    </style>
</head>
<body>
    <!-- Debug panel -->
    <div class="debug" id="debug"></div>
    
    <!-- Lower third container -->
    <div class="lower-third">
        <div class="content" id="content">
            <div class="show-title" id="showTitle">WHAT IS ART? #125</div>
            <div class="artist-name" id="artistName">LOADING...</div>
            <div class="song-title" id="songTitle"></div>
            <div class="writer-name" id="writerName"></div>
        </div>
    </div>
    
    <!-- Logo -->
    <div class="logo">MAKER RADIO</div>
    
    <script>
        console.log('[Lower Thirds] Script starting...');
        
        // Debug function
        function debug(msg) {
            console.log('[Lower Thirds]', msg);
            const debugEl = document.getElementById('debug');
            if (debugEl) {
                const time = new Date().toLocaleTimeString();
                debugEl.innerHTML = `${time}: ${msg}<br>` + debugEl.innerHTML;
                // Keep only last 10 messages
                const lines = debugEl.innerHTML.split('<br>');
                if (lines.length > 10) {
                    debugEl.innerHTML = lines.slice(0, 10).join('<br>');
                }
            }
        }
        
        // Calculate episode number
        function getEpisodeNumber() {
            const baseDate = new Date('2025-05-31');
            const baseEpisode = 122;
            const today = new Date();
            const weeksPassed = Math.floor((today - baseDate) / (1000 * 60 * 60 * 24 * 7));
            return baseEpisode + weeksPassed;
        }
        
        // Elements
        const content = document.getElementById('content');
        const showTitle = document.getElementById('showTitle');
        const artistName = document.getElementById('artistName');
        const songTitle = document.getElementById('songTitle');
        const writerName = document.getElementById('writerName');
        
        // Update episode number immediately
        showTitle.textContent = `WHAT IS ART? #${getEpisodeNumber()}`;
        
        // Function to show content
        function showContent(data) {
            debug(`Showing: ${data.artist}`);
            artistName.textContent = data.artist || '';
            songTitle.textContent = data.songTitle || '';
            writerName.textContent = data.songWriter ? `Written by ${data.songWriter}` : '';
            content.classList.add('visible');
        }
        
        // Function to hide content
        function hideContent() {
            debug('Hiding content');
            content.classList.remove('visible');
        }
        
        // Connect to SSE
        let eventSource = null;
        let reconnectTimer = null;
        
        function connect() {
            debug('Connecting to server...');
            
            // Clean up existing connection
            if (eventSource) {
                eventSource.close();
            }
            
            try {
                eventSource = new EventSource('http://localhost:3001/events');
                
                eventSource.onopen = function() {
                    debug('Connected!');
                    // Clear reconnect timer
                    if (reconnectTimer) {
                        clearTimeout(reconnectTimer);
                        reconnectTimer = null;
                    }
                };
                
                eventSource.onmessage = function(event) {
                    debug('Message: ' + event.data);
                    try {
                        const data = JSON.parse(event.data);
                        
                        // Check if we should hide
                        if (data.action === 'hide' || data.clear || data.hide) {
                            hideContent();
                        }
                        // Check if we have performer data
                        else if (data.artist) {
                            showContent(data);
                        }
                    } catch (e) {
                        debug('Parse error: ' + e.message);
                    }
                };
                
                eventSource.onerror = function() {
                    debug('Connection error - will retry in 2s');
                    eventSource.close();
                    hideContent();
                    
                    // Reconnect after 2 seconds
                    if (!reconnectTimer) {
                        reconnectTimer = setTimeout(connect, 2000);
                    }
                };
                
            } catch (e) {
                debug('Failed to connect: ' + e.message);
                // Retry in 2 seconds
                if (!reconnectTimer) {
                    reconnectTimer = setTimeout(connect, 2000);
                }
            }
        }
        
        // Start connection
        connect();
        
        // Also fetch current state immediately
        fetch('http://localhost:3001/current-performer')
            .then(response => response.json())
            .then(data => {
                debug('Current performer: ' + JSON.stringify(data));
                if (data && data.artist) {
                    showContent(data);
                } else {
                    hideContent();
                }
            })
            .catch(err => {
                debug('Failed to fetch current performer: ' + err.message);
            });
        
        // Manual controls for testing
        window.showLowerThird = function(artist, song, writer) {
            showContent({
                artist: artist || 'Test Artist',
                songTitle: song || 'Test Song',
                songWriter: writer || 'Test Writer'
            });
        };
        
        window.hideLowerThird = function() {
            hideContent();
        };
        
        // Enable debug
        window.enableDebug = function() {
            document.getElementById('debug').style.display = 'block';
        };
        
        debug('Ready');
    </script>
</body>
</html>